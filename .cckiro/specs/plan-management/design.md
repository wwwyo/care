# 計画書管理機能 設計書

## 1. システムアーキテクチャ概要

### 1.1 レイヤード・アーキテクチャ

```
┌─────────────────────────────────────────────────────┐
│                   Presentation Layer                 │
│           (Server Components + Server Actions)        │
├─────────────────────────────────────────────────────┤
│                    UseCase Layer                     │
│                  (Business Logic)                    │
├─────────────────────────────────────────────────────┤
│                    Domain Layer                      │
│                (Models & Services)                   │
├─────────────────────────────────────────────────────┤
│                Infrastructure Layer                  │
│          (Repositories / Query / External API)       │
└─────────────────────────────────────────────────────┘
```

### 1.2 データフロー

```
録音開始
    ↓
getUserMedia (マイク取得)
    ↓
AudioWorklet (音声処理)
    ↓
WebSocket → Speechmatics API
    ↓
リアルタイム文字起こし
    ↓
自然言語処理・項目抽出
    ↓
フォーム自動入力
    ↓
手動修正・追記
    ↓
下書き自動保存
    ↓
確定版作成
```

## 2. ドメインモデル設計

### 2.1 Plan集約（Aggregate Root）

**責務**
- 計画書の作成・更新・バージョン管理
- 下書きと確定版の状態遷移
- 内容の妥当性検証
- バージョン番号の採番

**主要な振る舞い**
- `createDraft`: 新規下書き作成
- `updateContent`: 内容の更新（下書きのみ）
- `publish`: 確定版への昇格
- `validate`: 必須項目の検証

**不変条件**
- 確定版は編集不可
- バージョン番号は連続する正の整数
- 必須項目が揃っていないと確定版にできない

### 2.2 PlanContent値オブジェクト

**構成要素**
- `desiredLife`: 希望する生活（文字列）
- `difficulties`: 困っていること（文字列）
- `services`: 利用希望サービス（配列）
- `considerations`: 配慮事項（オブジェクト）

**サービス種別**
- 在宅サービス
- 居住サービス
- 日中活動サービス
- その他サービス
- 児童サービス

### 2.3 HearingSession集約

**責務**
- ヒアリングセッションのライフサイクル管理
- 音声データと文字起こしの紐付け
- 抽出データの保持

**主要な振る舞い**
- `start`: セッション開始
- `end`: セッション終了と音声URL保存
- `addTranscript`: 文字起こし追加
- `setExtractedData`: 抽出データ設定

**データ構造**
- 音声ファイルURL
- タイムスタンプ付き文字起こし
- 話者識別情報
- 抽出された計画書項目

## 3. UseCase層設計

### 3.1 計画書管理ユースケース

**createOrUpdatePlan**
- 新規作成と更新を統一的に扱う
- 下書きとして自動保存
- ヒアリングセッションとの紐付け（オプション）

**publishPlan**
- 下書きから確定版への昇格
- 必須項目の検証
- バージョン番号の採番
- 将来的に同意リクエスト生成

### 3.2 ヒアリング管理ユースケース

**startHearingSession**
- セッション開始とWebSocket接続確立
- Speechmatics APIとの連携初期化
- セッションIDとWebSocket URLの返却

**endHearingSession**
- 録音終了と音声ファイル保存
- セッションのクローズ処理

**processTranscript**
- リアルタイム文字起こし処理
- NLPによる項目抽出
- 計画書への自動マッピング

## 4. Infrastructure層設計

### 4.1 リポジトリ実装

**PlanRepository**
- 計画書の永続化とトランザクション管理
- 下書きと確定版の分離保存
- バージョン履歴の管理

**HearingSessionRepository**
- ヒアリングセッションの保存
- 音声ファイルと文字起こしの管理
- 30日後の自動削除スケジューリング

### 4.2 外部サービス連携

**SpeechmaticsService**
- WebSocket接続の管理
- JWT認証トークンの生成
- リアルタイムAPIの設定
  - 言語: 日本語（ja）
  - 動作モード: enhanced（高精度）
  - Partial transcripts: 有効（低遅延）
  - 話者分離: 最大2名

**NLPService**
- 自然言語処理による項目抽出
- パターンマッチングによる分類
  - 希望表現の抽出
  - 困難表現の抽出
  - サービス種別の識別
  - 配慮事項の抽出
- 文脈を考慮した情報抽出

## 5. Presentation層設計

### 5.1 Server Components

**クライアント一覧画面**
- クライアント情報の表示
- 最終面談日と計画書ステータス
- 検索・フィルタリング機能

**クライアント詳細画面**
- 基本情報表示
- ヒアリング履歴（音声再生・文字起こし表示）
- 計画書履歴（バージョン管理）

**計画書編集画面**
- リアルタイム音声録音UI
- 自動入力フォーム
- 下書き自動保存
- 確定版作成

### 5.2 Server Actions

**計画書操作**
- `savePlanDraft`: 下書き保存
- `publishPlanAction`: 確定版作成
- `loadPlanHistory`: 履歴取得

**録音セッション操作**
- `startRecording`: 録音開始とWebSocket接続
- `stopRecording`: 録音終了と音声保存
- `processAudioStream`: ストリーミング処理

### 5.3 Client Components

**VoiceRecording**
- getUserMediaによるマイクアクセス
- AudioWorkletで音声データ処理
- WebSocket通信管理
- リアルタイム文字起こし表示
- 録音制御UI（開始/一時停止/終了）

**AutoFillForm**
- 抽出データによる自動入力
- 手動入力との競合制御
- 視覚的フィードバック
- デバウンス自動保存

## 6. データベース設計

### 6.1 主要テーブル

**plans**
- 計画書の基本情報
- ステータス（draft/published）
- 現在のバージョン番号

**plan_versions**
- 確定版の履歴
- バージョン番号と内容
- 公開日時と作成者

**plan_drafts**
- 下書きの内容
- ヒアリングセッションとの関連
- 自動保存のタイムスタンプ

**hearing_sessions**
- セッション情報
- 音声ファイルURL
- 文字起こしデータ（JSON）
- 抽出データ（JSON）

### 6.2 インデックス戦略

- クライアントIDによる検索の高速化
- 支援者IDによるフィルタリング
- テナント分離のための複合インデックス

## 7. セキュリティ設計

### 7.1 データ保護

- 音声データの暗号化（保存時・転送時）
- 個人情報の最小限収集
- 30日後の音声ファイル自動削除

### 7.2 アクセス制御

- RBACによる権限管理
- テナント間のデータ分離
- 監査ログの記録

### 7.3 API セキュリティ

- Speechmatics APIキーの環境変数管理
- WebSocket通信のTLS暗号化
- レート制限とDDoS対策

## 8. パフォーマンス最適化

### 8.1 リアルタイム処理

- WebSocketによる低遅延通信
- ストリーミング処理でメモリ効率化
- Web Workerによる並列処理

### 8.2 データベース最適化

- 適切なインデックス設計
- JSON型による柔軟なスキーマ
- ページネーションによる大量データ対応

### 8.3 フロントエンド最適化

- デバウンスによる自動保存の最適化
- 差分更新による再レンダリング最小化
- 遅延読み込みによる初期表示高速化

## 9. エラーハンドリング

### 9.1 エラー分類

- `NotFound`: リソース不在
- `ValidationError`: 入力値エラー
- `Unauthorized`: 権限エラー
- `ServiceError`: 外部サービスエラー

### 9.2 リカバリー戦略

- 自動リトライ（ネットワークエラー）
- フォールバック（音声認識失敗時は手動入力）
- グレースフルデグレード（部分的機能低下）

## 10. テスト戦略

### 10.1 単体テスト

- ドメインモデルのビジネスロジック
- NLP処理の精度検証
- バリデーションルール

### 10.2 統合テスト

- WebSocket通信の安定性
- 音声処理パイプライン
- データベーストランザクション

### 10.3 E2Eテスト

- 計画書作成フロー全体
- 録音から自動入力まで
- 下書きから確定版への遷移

## 11. 実装フェーズ

### Phase 1: 基本機能（1-2週間）
- クライアント管理画面（一覧・詳細・登録・編集）
- ドメインモデル実装
- 基本CRUD操作
- 計画書フォーム画面
- 下書き/確定版管理

### Phase 2: 音声録音（2-3週間）
- getUserMedia/AudioWorklet実装
- Speechmatics連携
- リアルタイム文字起こし
- 音声ファイル管理

### Phase 3: 自動マッピング（2-3週間）
- NLP処理実装
- リアルタイム項目抽出
- 自動入力機能
- ハイブリッド入力UI

### Phase 4: 統合・最適化（1週間）
- パフォーマンス調整
- エラーハンドリング強化
- UIブラッシュアップ
- テスト実装

## 12. 将来の拡張性

### 短期（3-6ヶ月）
- 複数話者の高精度識別
- AIによる面談要約
- テンプレート機能
- 外部システムAPI連携

### 中期（6-12ヶ月）
- 方言・専門用語辞書
- 多言語対応
- モバイルアプリ版
- 面談パターン分析

### 長期（1年以降）
- 機械学習による推奨質問
- 過去面談との比較分析
- 自動レポート生成
- 予測分析機能