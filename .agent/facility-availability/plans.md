## Purpose / Big Picture

Care Hubのサービス等利用計画書作成フローに、文脈を維持した施設リコメンドと空き情報共有を組み込み、相談支援専門員と事業所の双方が安心して最新情報を扱える状態を実現する。完了後、相談支援専門員は背景情報を添えた空き情報をもとに施設候補を比較・提示でき、事業所は直接更新されるリスクなく意向を反映できる。

## Initial Requirements & Scope

- スコープ内: `/clients/[id]/plans`でのリコメンド機能強化、相談支援専門員用と事業所用の空き情報保持、空き状況に背景メモを添付するUIと保存、リコメンド表示時に背景を併記。
- スコープ外: 事業所側管理画面の大幅改修、新しい認証/権限管理、外部API連携、自動学習によるリコメンド。
- 前提: 既存の計画作成ドメインを活用、空き情報は既存スキーマからの影響を受けず0ベースで再設計、ZodとPrismaのルールに従う。
- リコメンドでは相談支援専門員用・事業所用の二系統の空き情報を独立データとして扱い、競合解消ロジックは不要とする。
- 背景情報入力は即時保存を前提にし、下書き機能は導入しない。

## Milestones & Deliverables

| フェーズ | 主な成果物 | 完了基準 |
|-----------|-------------|-----------|
| 調査・要件整理 | 現状フローのギャップ分析、背景情報項目定義 | 関係者レビューで要件合意、空き情報データ分離方針承認 |
| 設計 | データモデル案、UIモック、ユースケース仕様 | DDDルールとCQRS仕様レビューで承認、バックログ化 |
| 実装 | ドメインモデル更新、サーバーアクション、UI実装、テスト | Bun Test/ lint 合格、コードレビュー承認 |
| 検証 | シナリオテスト、ステークホルダーデモ | 致命的不具合0、相談支援専門員ヒアリングで承認 |
| リリース | リリースノート、運用手順 | 本番反映準備完了、通知テンプレート作成 |

## Progress

- [x] [2025-10-19 07:01Z] プロジェクト開始：リポジトリ確認・既存計画案レビュー・ExecPlan初期化
- [x] [2025-10-19 07:45Z] 0ベース空き情報スキーマ案整理：事業所用・相談員用の独立テーブル構造、背景メモJSON設計
- [x] [2025-10-19 07:50Z] プレビュー/ドラフト非優先の方針決定：背景メモ入力のみで心理的ハードルを下げる
- [x] [2025-10-19 07:58Z] データモデル詳細ドラフト作成：`docs/availability-design.md`にPrisma案・アルゴリズム骨子を記録
- [x] [2025-10-19 08:05Z] 設計資料を日本語化し、`reportedById`必須・重み0.7/0.4への更新を反映
- [x] [2025-10-19 08:14Z] Availability実装完了：Prismaスキーマ更新、ドメイン/リポジトリ/ユースケース刷新、データ入力即時保存対応
- [x] [2025-10-19 08:14Z] UI/クエリ刷新：リコメンドスコア(◯/△/×+%)と背景メモ表示を実装、施設・相談員ビューを更新
- [x] [2025-10-19 10:32Z] 利用者初回登録の簡素化とヒアリングチェックリスト導入：ふりがな自動入力・生年月日必須化、ヒアリング画面に基礎情報プロンプトと要約テンプレートを追加
- [ ] ステークホルダーへの要件ヒアリング、ユーザーストーリーと受入基準定義
- [ ] 開発環境構築：インフラ設定、依存関係インストール、コードベース初期化
- [ ] MVPスコープ定義と優先順位付け
- [ ] コア機能実装（基本動作OK、エッジケース対応未完）
- [ ] 単体テスト作成と品質確認
- [ ] ピアレビュー実施と改善
- [ ] 結合テスト・デバッグ対応
- [ ] デプロイ計画、リリースノート、最終ドキュメント整備
- [ ] マイルストーンリリースとフィードバック収集

## Surprises & Discoveries

- 背景メモを直接登録できるだけで相談支援専門員の心理的ハードルが十分に下がるとの前提に変更し、プレビューやドラフト機能は当面優先しない。
- 相談支援専門員と事業所の空き情報を完全に別テーブルで保持する前提により、更新競合は発生しないため表示レイヤーでの統合に集中できる。
- `expiresAt` を一律30日後に自動設定することで、相談員の判断負荷を下げる案が有効そう。
- ローカルDBが起動しておらず Prisma migrate は保留中（`bunx prisma migrate dev` でP1001）。起動後に適用する必要あり。

## Decision Log

- [2025-10-19] ExecPlanは`.agent/plans.md`を正とし、`.agents`側は同期用途としない — ユーザー指定に基づく。
- [2025-10-19] 空き情報は事業所報告用と相談支援専門員観測用を完全に分離したスキーマで保存し、リコメンド時に統合参照する — ユーザー認識と合致。
- [2025-10-19] `facilityId` は両データに必須保持、`reportedById` は必須、`expiresAt` は保存時に30日後へ自動セット、リコメンド重みは施設0.7・相談員0.4で固定。
- [2025-10-19] リコメンドUIは◯/△/×表示に加えてスコア%を併記し、詳細には背景メモをリスト表示する運用とする。

## Outcomes & Retrospectives

マイルストーン未完了のため、達成事項・振り返りは保留中。主要フェーズ完了時に更新する。
