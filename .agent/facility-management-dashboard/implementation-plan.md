# 施設管理画面 実装計画

## 実装フェーズ概要

TDD（Test Driven Development）アプローチで段階的に実装を進めます。

## Phase 1: データベース基盤（推定時間: 2時間）

### 1.1 Prismaスキーマの拡張
- [ ] facilitiesテーブルに必要なフィールドを追加
  - service_type (施設種別)
  - description (施設紹介)
  - longitude, latitude (経度・緯度)
- [ ] slotsテーブルの作成
- [ ] マイグレーション実行

### 1.2 シードデータの準備
- [ ] CSVインポートスクリプトの作成
- [ ] テスト用データの投入

## Phase 2: ドメイン層（推定時間: 2時間）

### 2.1 ドメインモデルの実装
- [ ] Facilityクラスのテスト作成
- [ ] Facilityクラスの実装
- [ ] Slotクラスのテスト作成
- [ ] Slotクラスの実装

### 2.2 ビジネスロジックのテスト
- [ ] 空き状況変更のバリデーション
- [ ] 施設情報更新のバリデーション

## Phase 3: インフラ層（推定時間: 3時間）

### 3.1 リポジトリ実装
- [ ] FacilityRepositoryのテスト作成
- [ ] FacilityRepositoryの実装
- [ ] SlotRepositoryのテスト作成
- [ ] SlotRepositoryの実装

### 3.2 クエリ実装
- [ ] FacilityQueryのテスト作成
- [ ] FacilityQueryの実装
- [ ] InquiryQueryのテスト作成
- [ ] InquiryQueryの実装

## Phase 4: ユースケース層（推定時間: 2時間）

### 4.1 施設管理ユースケース
- [ ] UpdateFacilityUseCaseのテスト作成
- [ ] UpdateFacilityUseCaseの実装

### 4.2 空き状況管理ユースケース
- [ ] UpdateSlotStatusUseCaseのテスト作成
- [ ] UpdateSlotStatusUseCaseの実装

## Phase 5: UI実装（推定時間: 4時間）

### 5.1 共通コンポーネント
- [ ] SlotStatusButtonコンポーネント
- [ ] SlotStatusDisplayコンポーネント
- [ ] FacilityFormコンポーネント

### 5.2 ページ実装
- [ ] /facility - ダッシュボード
- [ ] /facility/edit - 基本情報編集
- [ ] /facility/slots - 空き状況更新
- [ ] /facility/inquiries - 照会一覧

### 5.3 Server Actions
- [ ] updateFacilityAction
- [ ] updateSlotStatusAction
- [ ] getInquiriesAction

## Phase 6: 統合テスト（推定時間: 1時間）

### 6.1 E2Eテスト
- [ ] 施設スタッフログインフロー
- [ ] 施設情報編集フロー
- [ ] 空き状況更新フロー

### 6.2 手動テスト
- [ ] モバイル表示確認
- [ ] エラーハンドリング確認

## 実装順序の根拠

1. **データベース基盤から開始**
   - 他のすべての層が依存するため最初に実装

2. **ドメイン層を次に実装**
   - ビジネスロジックの中核
   - 他の層から参照される

3. **インフラ層でデータアクセス実装**
   - ドメインモデルを永続化する責務

4. **ユースケース層で処理を統合**
   - ドメインとインフラを結合

5. **最後にUI層**
   - すべての基盤が整ってから実装

## テスト戦略

### ユニットテスト
- ドメインモデルのビジネスロジック
- リポジトリのデータアクセス
- ユースケースの処理フロー

### 統合テスト
- Server Actionsの動作確認
- データベースとの連携確認

### E2Eテスト
- 主要なユーザーフローの確認

## リスクと対策

### リスク1: オープンデータのフォーマット不整合
**対策**: フィールドマッピングを柔軟に設定可能にする

### リスク2: 既存テーブルとの整合性
**対策**: 既存スキーマを詳細に確認してから実装

### リスク3: パフォーマンス問題
**対策**: 必要最小限のデータのみ取得するクエリ設計

## 完了条件

- [ ] すべてのテストがパス
- [ ] 要件書の受け入れ基準を満たす
- [ ] モバイル表示が適切
- [ ] エラーメッセージが適切に表示される