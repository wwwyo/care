# 計画書管理機能 実装計画


**開発手法**: テスト駆動開発（TDD）
- 各機能はテストファースト
- テストとコードは同時に実装
- ドキュメントはコードに内包

## Phase 1: 基本機能（1-2週間）

### Week 1: クライアント管理とドメイン基盤

#### Day 1-2: クライアント管理基盤
- [ ] クライアント用のPrismaスキーマ拡張
- [ ] クライアントドメインモデル作成
- [ ] クライアントリポジトリ実装
- [ ] クライアント作成・更新UseCase

#### Day 3-4: クライアント管理画面
- [ ] クライアント一覧画面（Server Component）
- [ ] 検索・フィルタリング機能
- [ ] ページネーション実装
- [ ] クライアント詳細画面

#### Day 5: クライアント編集機能
- [ ] クライアント新規登録フォーム
- [ ] クライアント編集フォーム
- [ ] Server Actions実装
- [ ] バリデーション処理

### Week 2: 計画書基本機能

#### Day 6-7: 計画書ドメインモデル
- [ ] Plan集約の実装
- [ ] PlanContent値オブジェクト
- [ ] PlanRepositoryの基本実装
- [ ] 下書き/確定版の状態管理

#### Day 8-9: 計画書CRUD
- [ ] 計画書作成UseCase
- [ ] 計画書更新UseCase
- [ ] 計画書確定UseCase
- [ ] バージョン管理ロジック

#### Day 10: 計画書UI基本実装
- [ ] 計画書編集フォーム（基本版）
- [ ] 自動保存機能
- [ ] 確定版作成フロー
- [ ] 計画書履歴表示

## Phase 2: 音声録音機能

### Week 3: 音声録音基盤

#### Day 11-12: 音声録音実装
- [ ] getUserMedia実装
- [ ] AudioWorkletProcessor作成
- [ ] 音声データのバッファリング
- [ ] 録音制御（開始/停止/一時停止）

#### Day 13-14: 音声ファイル管理
- [ ] 音声ファイルのBlob生成
- [ ] Supabase Storageへのアップロード
- [ ] 音声ファイルURL管理
- [ ] 30日自動削除の設定

#### Day 15: ヒアリングセッション
- [ ] HearingSessionドメインモデル
- [ ] HearingSessionRepository
- [ ] セッション管理UseCase

### 文字起こしAPI連携

#### Day 16-17: WebSocket接続
- [ ] Speechmatics認証JWT生成
- [ ] WebSocket接続管理
- [ ] 再接続ロジック
- [ ] エラーハンドリング

#### Day 18-19: リアルタイム文字起こし
- [ ] 音声ストリーミング送信
- [ ] Partial transcripts受信
- [ ] Final transcripts処理
- [ ] タイムスタンプ管理

#### Day 20: 文字起こしUI
- [ ] リアルタイム表示コンポーネント
- [ ] 話者識別表示
- [ ] タイムスタンプ付き表示
- [ ] 音声再生との同期

## Phase 3: 自動マッピング（2-3週間）

### Week 5: NLP処理

#### Day 21-22: 自然言語処理
- [ ] NLPService実装
- [ ] 希望表現パターン抽出
- [ ] 困難表現パターン抽出
- [ ] サービス種別識別

#### Day 23-24: 配慮事項抽出
- [ ] キーワード抽出
- [ ] 文脈情報の取得
- [ ] 信頼度スコア計算
- [ ] 抽出結果の構造化

#### Day 25: マッピングロジック
- [ ] 抽出データから計画書項目への変換
- [ ] 既存データとの競合制御
- [ ] 増分更新ロジック

### Week 6: 自動入力UI

#### Day 26-27: 自動入力実装
- [ ] リアルタイム自動入力
- [ ] 視覚的フィードバック
- [ ] 自動入力フィールドのハイライト
- [ ] 信頼度表示

#### Day 28-29: ハイブリッド入力
- [ ] 手動編集との共存
- [ ] 自動入力の上書き防止
- [ ] 編集履歴管理
- [ ] Undo/Redo機能

#### Day 30: 統合テスト
- [ ] 録音→文字起こし→マッピング統合
- [ ] パフォーマンステスト
- [ ] エッジケーステスト

## Phase 4: 統合・最適化（1週間）

### Week 7: 品質向上

#### Day 31-32: パフォーマンス最適化
- [ ] デバウンス処理の調整
- [ ] メモリリーク対策
- [ ] レンダリング最適化
- [ ] ネットワーク通信最適化

#### Day 33-34: エラーハンドリング
- [ ] 録音エラー対応
- [ ] ネットワーク切断対応
- [ ] API制限対応
- [ ] ユーザーフィードバック改善

#### Day 35: UIブラッシュアップ
- [ ] レスポンシブ対応
- [ ] アクセシビリティ改善
- [ ] ローディング状態の改善
- [ ] エラーメッセージの改善

### Week 8: 統合とリリース準備

#### Day 36-37: 統合動作確認
- [ ] 全フローの動作確認
- [ ] エッジケースの検証
- [ ] パフォーマンス測定
- [ ] メモリ使用量の確認

#### Day 38-40: リリース準備
- [ ] 環境変数の設定確認
- [ ] 本番環境デプロイ
- [ ] ロールバック手順確認
- [ ] 監視設定
- [ ] 初期データ投入


## リスク要因と対策

### 技術的リスク

| リスク | 対策 | 期限への影響 |
|-------|------|-------------|
| Speechmatics API連携の遅延 | モックAPIで並行開発 | 低 |
| 音声認識精度の問題 | 手動入力で補完 | 低 |
| AudioWorklet対応ブラウザ | フォールバック実装 | 中 |
| NLP精度不足 | ルールベース強化 | 低 |

### スケジュールリスク

| リスク | 対策 | 期限への影響 |
|-------|------|-------------|
| Phase 1の遅延 | Phase 2,3を並行実施 | 中 |
| 外部API仕様変更 | アダプター層で吸収 | 低 |
| 統合確認不足 | 各Phase完了時に統合確認 | 低 |

## 成功指標（KPI）

### Phase 1完了時
- [ ] クライアント登録・編集が可能
- [ ] 計画書の作成・保存が可能
- [ ] 下書きと確定版の管理が機能

### Phase 2完了時
- [ ] 60分の音声録音が可能
- [ ] リアルタイム文字起こし遅延3秒以内
- [ ] 文字起こし精度80%以上

### Phase 3完了時
- [ ] 主要項目の自動入力成功率70%以上
- [ ] 手動修正との競合なし
- [ ] ユーザーテストでの満足度80%以上

### Phase 4完了時
- [ ] 全機能の統合動作確認
- [ ] レスポンスタイム要件達成
- [ ] 全機能のTDD実装完了

## 依存関係

### 外部サービス
- Speechmatics API契約とAPIキー取得
- Supabase Storage設定
- 本番環境のマイク権限設定

### 内部依存
- 認証システム（既存）
- テナント管理（既存）
- 監査ログ（既存）