// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// =====================================================
// 基本テーブル
// =====================================================

// tenants: マルチテナント用の組織テーブル

model Tenant {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String   @db.VarChar(255)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  supporters Supporter[]
  clients    Client[]
  plans      Plan[]

  @@map("tenants")
}

// supporters: 相談員（相談支援専門員）

model Supporter {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  tenant              Tenant                      @relation(fields: [tenantId], references: [id])
  user                User                        @relation(fields: [userId], references: [id])
  profile             SupporterProfile?
  clientSupporters    ClientSupporter[]
  planVersionsCreated PlanVersion[]               @relation("PlanVersionCreatedBy")
  hearingMemos        HearingMemo[]
  availabilityNotes   SupporterAvailabilityNote[]

  @@index([tenantId])
  @@index([userId])
  @@map("supporters")
}

// clients: サービス利用者

model Client {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  tenant                    Tenant                      @relation(fields: [tenantId], references: [id])
  profile                   ClientProfile?
  addresses                 ClientAddress[]
  clientSupporters          ClientSupporter[]
  plans                     Plan[]
  hearingMemos              HearingMemo[]
  SupporterAvailabilityNote SupporterAvailabilityNote[]

  @@index([tenantId])
  @@map("clients")
}

// client_supporters: 利用者と相談員の中間テーブル
model ClientSupporter {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  clientId    String   @map("client_id") @db.Uuid
  supporterId String   @map("supporter_id") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  client    Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  supporter Supporter @relation(fields: [supporterId], references: [id], onDelete: Cascade)

  @@unique([clientId, supporterId])
  @@index([clientId])
  @@index([supporterId])
  @@map("client_supporters")
}

// facilities: 施設

model Facility {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  profile                    FacilityProfile?
  location                   FacilityLocation?
  contacts                   FacilityContact[]
  services                   FacilityService[]
  conditions                 FacilityCondition[]
  businessHours              FacilityBusinessHour[]
  staff                      FacilityStaffFacility[]
  availabilityReports        FacilityAvailabilityReport[]
  supporterAvailabilityNotes SupporterAvailabilityNote[]
  inquiries                  Inquiry[]

  @@map("facilities")
}

// facility_staff: 施設職員

model FacilityStaff {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  user                User                         @relation(fields: [userId], references: [id])
  facilities          FacilityStaffFacility[]
  availabilityReports FacilityAvailabilityReport[]

  @@index([userId])
  @@map("facility_staff")
}

// facility_staff_facilities: 施設職員と施設の関連

model FacilityStaffFacility {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  facilityStaffId String   @map("facility_staff_id") @db.Uuid
  facilityId      String   @map("facility_id") @db.Uuid
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz

  facilityStaff FacilityStaff @relation(fields: [facilityStaffId], references: [id], onDelete: Cascade)
  facility      Facility      @relation(fields: [facilityId], references: [id])

  @@unique([facilityStaffId, facilityId])
  @@index([facilityStaffId])
  @@index([facilityId])
  @@map("facility_staff_facilities")
}

// =====================================================
// プロファイル関連テーブル
// =====================================================

// supporter_profiles: 相談員プロファイル

model SupporterProfile {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  supporterId String    @unique @map("supporter_id") @db.Uuid
  name        String    @db.VarChar(255)
  nameKana    String?   @map("name_kana") @db.VarChar(255)
  gender      String?   @db.VarChar(10)
  birthDate   DateTime? @map("birth_date") @db.Date
  phone       String?   @db.VarChar(20)
  tenantId    String    @map("tenant_id") @db.Uuid
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  supporter Supporter @relation(fields: [supporterId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("supporter_profiles")
}

// user_profiles: 利用者プロファイル

model ClientProfile {
  id                       String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  clientId                 String    @unique @map("client_id") @db.Uuid
  name                     String    @db.VarChar(255)
  nameKana                 String?   @map("name_kana") @db.VarChar(255)
  gender                   String?   @db.VarChar(10)
  birthDate                DateTime? @map("birth_date") @db.Date
  phone                    String?   @db.VarChar(20)
  disability               String?   @db.VarChar(255)
  careLevel                String?   @map("care_level") @db.VarChar(50)
  notes                    String?   @db.Text
  emergencyContactName     String?   @map("emergency_contact_name") @db.VarChar(255)
  emergencyContactRelation String?   @map("emergency_contact_relation") @db.VarChar(50)
  emergencyContactPhone    String?   @map("emergency_contact_phone") @db.VarChar(20)
  createdAt                DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt                DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@map("client_profiles")
}

// client_addresses: 利用者住所

model ClientAddress {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  clientId   String   @map("client_id") @db.Uuid
  postalCode String?  @map("postal_code") @db.VarChar(10)
  prefecture String?  @db.VarChar(10)
  city       String?  @db.VarChar(100)
  street     String?  @db.VarChar(255)
  building   String?  @db.VarChar(255)
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt  DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@map("client_addresses")
}

// facility_profiles: 施設プロファイル

model FacilityProfile {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  facilityId    String   @unique @map("facility_id") @db.Uuid
  name          String   @db.VarChar(255)
  nameKana      String?  @map("name_kana") @db.VarChar(255)
  description   String?  @db.Text
  capacity      Int?
  wamId         String?  @map("wam_id") @db.VarChar(50)
  officialId    String?  @map("official_id") @db.VarChar(20)
  corporationId String?  @map("corporation_id") @db.Uuid
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  facility    Facility             @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  corporation FacilityCorporation? @relation(fields: [corporationId], references: [id])

  @@index([wamId])
  @@index([officialId])
  @@index([corporationId])
  @@map("facility_profiles")
}

// facility_locations: 施設所在地

model FacilityLocation {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  facilityId    String   @unique @map("facility_id") @db.Uuid
  postalCode    String?  @map("postal_code") @db.VarChar(10)
  addressCity   String?  @map("address_city") @db.VarChar(200)
  addressDetail String?  @map("address_detail") @db.VarChar(500)
  building      String?  @db.VarChar(255)
  latitude      Decimal? @db.Decimal(10, 8)
  longitude     Decimal? @db.Decimal(11, 8)
  accessInfo    String?  @map("access_info") @db.Text
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  facility Facility @relation(fields: [facilityId], references: [id], onDelete: Cascade)

  @@index([latitude, longitude])
  @@map("facility_locations")
}

// facility_contacts: 施設連絡先

model FacilityContact {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  facilityId  String   @map("facility_id") @db.Uuid
  contactType String   @map("contact_type") @db.VarChar(20)
  name        String?  @db.VarChar(255)
  phone       String?  @db.VarChar(20)
  fax         String?  @db.VarChar(20)
  email       String?  @db.VarChar(255)
  website     String?  @db.VarChar(255)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz

  facility Facility @relation(fields: [facilityId], references: [id], onDelete: Cascade)

  @@index([facilityId])
  @@map("facility_contacts")
}

// facility_services: 施設提供サービス

model FacilityService {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  facilityId  String   @map("facility_id") @db.Uuid
  serviceType String   @map("service_type") @db.VarChar(100)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz

  facility Facility @relation(fields: [facilityId], references: [id], onDelete: Cascade)

  @@index([facilityId])
  @@index([serviceType])
  @@map("facility_services")
}

// facility_conditions: 施設条件・設備

model FacilityCondition {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  facilityId     String   @map("facility_id") @db.Uuid
  conditionType  String   @map("condition_type") @db.VarChar(50)
  conditionValue String?  @map("condition_value") @db.VarChar(255)
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz

  facility Facility @relation(fields: [facilityId], references: [id], onDelete: Cascade)

  @@index([facilityId])
  @@index([conditionType])
  @@map("facility_conditions")
}

// facility_corporations: 法人

model FacilityCorporation {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name            String   @db.VarChar(255)
  nameKana        String?  @map("name_kana") @db.VarChar(255)
  corporateNumber String?  @unique @map("corporate_number") @db.VarChar(13)
  postalCode      String?  @map("postal_code") @db.VarChar(10)
  addressCity     String?  @map("address_city") @db.VarChar(200)
  addressDetail   String?  @map("address_detail") @db.VarChar(500)
  phone           String?  @db.VarChar(20)
  fax             String?  @db.VarChar(20)
  url             String?  @db.VarChar(255)
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  facilities FacilityProfile[]

  @@index([corporateNumber])
  @@map("facility_corporations")
}

// facility_business_hours: 施設営業時間

model FacilityBusinessHour {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  facilityId      String   @unique @map("facility_id") @db.Uuid
  weekdayHours    String?  @map("weekday_hours") @db.Text
  saturdayHours   String?  @map("saturday_hours") @db.Text
  sundayHours     String?  @map("sunday_hours") @db.Text
  holidayHours    String?  @map("holiday_hours") @db.Text
  regularHolidays String?  @map("regular_holidays") @db.Text
  notes           String?  @db.Text
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  facility Facility @relation(fields: [facilityId], references: [id], onDelete: Cascade)

  @@map("facility_business_hours")
}

// =====================================================
// ビジネスロジックテーブル
// =====================================================

// plans: ケアプラン

model Plan {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId         String   @map("tenant_id") @db.Uuid
  clientId         String   @map("client_id") @db.Uuid
  currentVersionId String?  @map("current_version_id") @db.Uuid
  status           String   @default("draft") @db.VarChar(20)
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  tenant                    Tenant                      @relation(fields: [tenantId], references: [id])
  client                    Client                      @relation(fields: [clientId], references: [id])
  versions                  PlanVersion[]
  consents                  Consent[]
  inquiries                 Inquiry[]
  SupporterAvailabilityNote SupporterAvailabilityNote[]

  @@unique([clientId])
  @@index([tenantId])
  @@index([currentVersionId])
  @@map("plans")
}

// plan_versions: ケアプランバージョン

model PlanVersion {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  planId          String    @map("plan_id") @db.Uuid
  versionNumber   Int       @map("version_number")
  versionType     String    @default("draft") @map("version_type") @db.VarChar(20) // draft | published
  desiredLife     String?   @map("desired_life") @db.Text // 希望する生活（厚労省様式1）
  troubles        String?   @db.Text // 困っていること（厚労省様式2）
  considerations  String?   @db.Text // 配慮してほしいこと（厚労省様式4）
  validFrom       DateTime  @default(now()) @map("valid_from") @db.Timestamptz
  validUntil      DateTime? @map("valid_until") @db.Timestamptz
  createdBy       String    @map("created_by") @db.Uuid
  reasonForUpdate String?   @map("reason_for_update") @db.Text
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  plan                      Plan                           @relation(fields: [planId], references: [id], onDelete: Cascade)
  creator                   Supporter                      @relation("PlanVersionCreatedBy", fields: [createdBy], references: [id])
  services                  PlanService[] // 利用したいサービス（厚労省様式3）
  accessibilityRequirements PlanAccessibilityRequirement[]
  customFields              PlanCustomField[]

  @@unique([planId, versionNumber])
  @@index([planId])
  @@index([versionType])
  @@index([validFrom])
  @@index([validUntil])
  @@map("plan_versions")
}

// plan_accessibility_requirements: アクセシビリティ要件

model PlanAccessibilityRequirement {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  planVersionId   String   @map("plan_version_id") @db.Uuid
  requirementType String   @map("requirement_type") @db.VarChar(50)
  details         String?  @db.Text
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz

  planVersion PlanVersion @relation(fields: [planVersionId], references: [id], onDelete: Cascade)

  @@index([planVersionId])
  @@index([requirementType])
  @@map("plan_accessibility_requirements")
}

// plan_custom_fields: カスタムフィールド

model PlanCustomField {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  planVersionId String   @map("plan_version_id") @db.Uuid
  fieldName     String   @map("field_name") @db.VarChar(100)
  fieldValue    String?  @map("field_value") @db.Text
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz

  planVersion PlanVersion @relation(fields: [planVersionId], references: [id], onDelete: Cascade)

  @@index([planVersionId])
  @@map("plan_custom_fields")
}

// plan_services: 利用したいサービス（厚労省様式3）

model PlanService {
  id                   String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  planVersionId        String   @map("plan_version_id") @db.Uuid
  serviceCategory      String   @map("service_category") @db.VarChar(50) // home | residential | daytime | other | child
  serviceType          String   @map("service_type") @db.VarChar(100)
  desiredAmount        String?  @map("desired_amount") @db.VarChar(255) // 希望するサービス量
  desiredLifeByService String?  @map("desired_life_by_service") @db.Text // サービス利用により望まれる生活
  achievementPeriod    String?  @map("achievement_period") @db.VarChar(100) // 達成時期
  createdAt            DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt            DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  planVersion PlanVersion @relation(fields: [planVersionId], references: [id], onDelete: Cascade)

  @@index([planVersionId])
  @@index([serviceCategory])
  @@index([serviceType])
  @@map("plan_services")
}

// hearing_transcripts: 文字起こしデータ

model HearingTranscript {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  hearingMemoId  String   @map("hearing_memo_id") @db.Uuid
  transcriptType String   @map("transcript_type") @db.VarChar(20) // partial | final
  content        String   @db.Text
  timestamp      Decimal  @db.Decimal(13, 3) // 開始時刻（秒）
  endTimestamp   Decimal? @map("end_timestamp") @db.Decimal(13, 3) // 終了時刻（秒）
  speaker        String?  @db.VarChar(50) // supporter | client | unknown
  confidence     Decimal? @db.Decimal(3, 2) // 信頼度スコア（0-1）
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz

  hearingMemo HearingMemo @relation(fields: [hearingMemoId], references: [id], onDelete: Cascade)

  @@index([hearingMemoId])
  @@index([timestamp])
  @@map("hearing_transcripts")
}

// hearing_memos: ヒアリングメモ

model HearingMemo {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  clientId    String   @map("client_id") @db.Uuid
  supporterId String   @map("supporter_id") @db.Uuid
  date        DateTime @db.Date
  title       String   @db.VarChar(255)
  content     String   @db.Text // 議事録
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  client      Client              @relation(fields: [clientId], references: [id], onDelete: Cascade)
  supporter   Supporter           @relation(fields: [supporterId], references: [id], onDelete: Cascade)
  transcripts HearingTranscript[] // 文字起こし
  audioFiles  HearingAudio[] // 音声ファイル

  @@index([clientId])
  @@index([supporterId])
  @@index([date])
  @@map("hearing_memos")
}

// hearing_audios: 音声ファイル管理

model HearingAudio {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  hearingMemoId String   @map("hearing_memo_id") @db.Uuid
  audioFileUrl  String   @map("audio_file_url") @db.Text
  duration      Int? // 録音時間（秒）
  status        String   @default("completed") @db.VarChar(20) // recording | processing | completed | error
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz

  hearingMemo HearingMemo @relation(fields: [hearingMemoId], references: [id], onDelete: Cascade)

  @@index([hearingMemoId])
  @@map("hearing_audios")
}

// facility_availability_reports: 施設側空き状況レポート

model FacilityAvailabilityReport {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  facilityId     String    @map("facility_id") @db.Uuid
  status         String    @db.VarChar(20)
  validFrom      DateTime  @map("valid_from") @db.Timestamptz
  validUntil     DateTime? @map("valid_until") @db.Timestamptz
  note           String?   @db.Text
  contextSummary String?   @map("context_summary") @db.VarChar(200)
  contextDetails Json      @map("context_details")
  confidence     Int?      @db.SmallInt
  reportedById   String    @map("reported_by_id") @db.Uuid
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt      DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  facility Facility      @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  reporter FacilityStaff @relation(fields: [reportedById], references: [id], onDelete: Cascade)

  @@index([facilityId, validUntil])
  @@index([status])
  @@map("facility_availability_reports")
}

// supporter_availability_notes: 相談員側空き状況メモ

model SupporterAvailabilityNote {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  facilityId     String   @map("facility_id") @db.Uuid
  supporterId    String   @map("supporter_id") @db.Uuid
  planId         String?  @map("plan_id") @db.Uuid
  clientId       String?  @map("client_id") @db.Uuid
  status         String   @db.VarChar(20)
  intent         String?  @db.VarChar(30)
  note           String?  @db.Text
  contextSummary String?  @map("context_summary") @db.VarChar(200)
  contextDetails Json     @map("context_details")
  expiresAt      DateTime @map("expires_at") @db.Timestamptz
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt      DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  facility  Facility  @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  supporter Supporter @relation(fields: [supporterId], references: [id], onDelete: Cascade)
  plan      Plan?     @relation(fields: [planId], references: [id], onDelete: SetNull)
  client    Client?   @relation(fields: [clientId], references: [id], onDelete: SetNull)

  @@index([facilityId, supporterId])
  @@index([planId])
  @@index([clientId])
  @@map("supporter_availability_notes")
}

// =====================================================
// 関連テーブル
// =====================================================

// consents: 同意リクエスト

model Consent {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  planId      String   @map("plan_id") @db.Uuid
  requestType String   @map("request_type") @db.VarChar(20)
  token       String   @unique @db.VarChar(255)
  expiresAt   DateTime @map("expires_at") @db.Timestamptz
  status      String   @default("pending") @db.VarChar(20)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  plan   Plan           @relation(fields: [planId], references: [id])
  grants ConsentGrant[]

  @@index([planId])
  @@index([token])
  @@index([status])
  @@map("consents")
}

// consent_grants: 同意記録

model ConsentGrant {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  consentId String   @map("consent_id") @db.Uuid
  grantedAt DateTime @default(now()) @map("granted_at") @db.Timestamptz
  grantedBy String?  @map("granted_by") @db.VarChar(255)
  method    String   @map("method") @db.VarChar(50)
  ipAddress String?  @map("ip_address") @db.VarChar(45)
  userAgent String?  @map("user_agent") @db.Text
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  consent Consent @relation(fields: [consentId], references: [id], onDelete: Cascade)

  @@index([consentId])
  @@map("consent_grants")
}

// inquiries: 照会

model Inquiry {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  planId     String   @map("plan_id") @db.Uuid
  facilityId String   @map("facility_id") @db.Uuid
  status     String   @default("open") @db.VarChar(20)
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt  DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  plan     Plan             @relation(fields: [planId], references: [id])
  facility Facility         @relation(fields: [facilityId], references: [id])
  messages InquiryMessage[]
  replies  InquiryReply[]

  @@index([planId])
  @@index([facilityId])
  @@index([status])
  @@map("inquiries")
}

// inquiry_messages: 照会メッセージ

model InquiryMessage {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  inquiryId  String   @map("inquiry_id") @db.Uuid
  message    String   @db.Text
  senderType String   @map("sender_type") @db.VarChar(20)
  senderId   String   @map("sender_id") @db.Uuid
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz

  inquiry Inquiry @relation(fields: [inquiryId], references: [id], onDelete: Cascade)

  @@index([inquiryId])
  @@index([senderId])
  @@map("inquiry_messages")
}

// inquiry_replies: 照会返信

model InquiryReply {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  inquiryId String   @map("inquiry_id") @db.Uuid
  replyType String   @map("reply_type") @db.VarChar(20)
  replyData Json     @map("reply_data") @db.Json
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  inquiry Inquiry @relation(fields: [inquiryId], references: [id], onDelete: Cascade)

  @@index([inquiryId])
  @@map("inquiry_replies")
}

// audits: 監査ログ（append-only）

model Audit {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tableName String   @map("table_name") @db.VarChar(50)
  recordId  String   @map("record_id") @db.Uuid
  action    String   @db.VarChar(20)
  actorId   String   @map("actor_id") @db.Uuid
  actorType String   @map("actor_type") @db.VarChar(20)
  changes   Json?    @db.Json
  metadata  Json?    @db.Json
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  @@index([tableName, recordId])
  @@index([actorId])
  @@index([createdAt])
  @@map("audits")
}

// better-authの認証専用テーブル
model User {
  id            String    @id
  name          String
  email         String
  emailVerified Boolean
  image         String?
  createdAt     DateTime
  updatedAt     DateTime
  sessions      Session[]
  accounts      Account[]

  realm String

  supporters    Supporter[]
  facilityStaff FacilityStaff[]

  @@unique([email])
  @@map("users")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime
  updatedAt DateTime
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@map("sessions")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime
  updatedAt             DateTime

  @@map("accounts")
}

model Verification {
  id         String    @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime?
  updatedAt  DateTime?

  @@map("verifications")
}
