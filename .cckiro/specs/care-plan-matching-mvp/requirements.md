# ケアプラン施設マッチングシステム MVP 要件書

## 1. プロダクト概要

厚生労働省標準様式の「サービス等利用計画書」をベースに、福祉施設の空き状況と連動した施設候補検索と、利用者への同意取得をワンストップで実現するWebアプリケーション。

## 2. 対象ユーザーとロール

### 2.1 支援者（Supporter）
- **定義**: 相談支援専門員、ケアマネージャー
- **所属**: 一つのテナント（事業所）にのみ属する
- **担当**: 複数のUser（サービス利用者）を担当
- **主な作業**:
  - サービス等利用計画書の入力/アップロード
  - 施設候補の検索と選定
  - 利用者への同意確認依頼
  - ケース進捗管理

### 2.2 サービス利用者（User）
- **定義**: 福祉サービスを利用するエンドユーザー本人または家族
- **関係**: Supporterによって支援を受ける
- **主な作業**:
  - 自分のサービス利用計画書の閲覧
  - 施設選定結果の確認
  - 同意の承認（ワンタップ）
  - マイページでの情報確認
- **アクセス方法**:
  - 同意確認リンク経由（認証不要）
  - マイページログイン（Magic Link認証）

### 2.3 施設スタッフ（FacilityStaff）
- **定義**: 福祉施設のスタッフ
- **ロール**: 
  - admin: 施設管理者（すべての機能を利用可能）
  - staff: 一般スタッフ（空き状況更新、照会対応）
  - viewer: 閲覧のみ
- **主な作業**:
  - 空き状況の更新（○/△/×）（admin/staff）
  - 照会への返信（受入可否＋コメント）（admin/staff）
  - 情報の閲覧（全ロール）

## 3. 機能要件

### 3.1 認証・認可
- **FR-AUTH-001**: Supabase Auth (Magic Link)によるログイン
- **FR-AUTH-002**: ロールベースアクセス制御（RBAC）
  - Supporter: plans/search/inquiries/consentsの作成・閲覧
  - FacilityStaff: ロールに応じた自施設のslots/inquiries管理
  - User: 自分のplans/consentsの閲覧、同意承認（認証またはトークン経由）
- **FR-AUTH-003**: マルチテナント対応
  - Supporterは1つのテナントにのみ所属
  - FacilityStaffは複数施設に所属可能（施設ごとにロールを持つ）

### 3.2 計画書管理
- **FR-PLAN-001**: 厚生労働省標準様式に準拠した必須項目の入力フォーム
- **FR-PLAN-002**: PDFファイルのアップロード対応
- **FR-PLAN-003**: 計画書情報の自動解析と項目マッピング
- **FR-PLAN-004**: 計画書のバージョン管理
  - 定期更新時に新バージョン作成
  - 更新理由の記録
  - 過去バージョンの閲覧機能
  - バージョン間の差分表示

### 3.3 施設検索・マッチング
- **FR-SEARCH-001**: 計画書の内容に基づく自動マッチング
  - サービス種別（生活介護/就労継続等）の一致
  - 地域（10km以内優先の距離順ソート）
  - 条件（送迎可否/バリアフリー等）の一致
- **FR-SEARCH-002**: 空き状況による並べ替え（open > limited > closed > unknown）
- **FR-SEARCH-003**: 検索結果の絞り込み・並べ替え機能
  - 距離順
  - 空き状況順
- **FR-SEARCH-004**: 検索結果の一時保存
  - マッチング結果はセッションまたはキャッシュで管理
  - 永続的な保存は行わない

### 3.4 空き状況管理
- **FR-SLOT-001**: 施設ごとの空き状況更新（○/△/×）
- **FR-SLOT-002**: 空き情報の有効期限設定
- **FR-SLOT-003**: 期限切れ時の自動ステータス変更（"空き不明"へ）
- **FR-SLOT-004**: 空き状況変更のリアルタイム反映
- **FR-SLOT-005**: 空き状況の詳細条件設定
  - 年齢制限、性別制限などの追加条件を別途管理

### 3.5 同意管理
- **FR-CONSENT-001**: 利用者への施設選定結果共有リンク生成
- **FR-CONSENT-002**: ワンタップでの同意承認
- **FR-CONSENT-003**: 同意証跡の保存
  - 承認日時
  - 承認方法
  - IPアドレス
  - User Agent
- **FR-CONSENT-004**: 同意の2段階管理
  - 同意リクエストと同意記録を分離
  - 未同意・同意済みの状態管理

### 3.6 照会管理
- **FR-INQUIRY-001**: 施設への照会送信
- **FR-INQUIRY-002**: 施設側からの受入可否返信
  - 受入可/不可の選択
  - コメント追加（必須）
- **FR-INQUIRY-003**: 照会ステータス管理（sent/replied/closed）
- **FR-INQUIRY-004**: メッセージ履歴管理
  - 支援者・施設間の複数メッセージやり取り対応
  - 送信者種別の記録

### 3.7 ケース進捗管理
- **FR-CASE-001**: Plan → Search → Consentの進捗表示
- **FR-CASE-002**: 各ステップの完了状態可視化

## 4. 非機能要件

### 4.1 セキュリティ
- **NFR-SEC-001**: HTTPS/TLSによる通信暗号化
- **NFR-SEC-002**: データベースのat-rest暗号化
- **NFR-SEC-003**: 最小限の個人情報収集（利用者連絡先のみ）
- **NFR-SEC-004**: マルチテナント分離（テナント間のデータアクセス制御）

### 4.2 監査・コンプライアンス
- **NFR-AUDIT-001**: 全ての重要操作の監査ログ記録
  - アクター、アクション、対象、IPアドレス、User Agentを記録
  - 変更前後の差分は記録しない（シンプルな設計）
- **NFR-AUDIT-002**: 同意取得の証跡保存（法的要件準拠）

### 4.3 ユーザビリティ
- **NFR-UX-001**: 同意共有送信まで2クリック以内
- **NFR-UX-002**: レスポンシブデザイン（モバイル対応）
- **NFR-UX-003**: 空き状況の視覚的表現（○/△/×/灰色）

### 4.4 パフォーマンス
- **NFR-PERF-001**: 検索結果表示3秒以内
- **NFR-PERF-002**: 空き状況更新の即時反映（1秒以内）

## 5. 技術要件

### 5.1 ランタイム・パッケージ管理
- Runtime: Bun
- Package Manager: Bun

### 5.2 フロントエンド
- React 19 + Next.js 15 (App Router) + TypeScript
- Tailwind CSS v4
- shadcn/ui コンポーネントライブラリ

### 5.3 バックエンド
- Server Components + Server Actions
- ドメイン駆動設計（DDD）アーキテクチャ

### 5.4 データベース
- Supabase (PostgreSQL)
- Row Level Security (RLS)
- 高度に正規化されたテーブル設計
- リアルタイム更新対応

## 6. MVP画面構成

### 6.1 共通
1. **/login** - ログイン画面（Supporter/FacilityStaff/User共通）

### 6.2 Supporter向け
2. **/plans/import** - 計画書入力/アップロード画面
3. **/search/results** - 施設検索結果画面
4. **/cases/:id** - ケース進捗確認画面

### 6.3 FacilityStaff向け
5. **/facility/slots** - 施設空き状況更新画面
6. **/facility/inquiries** - 照会管理画面

### 6.4 User向け
7. **/consent/:token** - 利用者同意確認画面（認証不要）
8. **/my/plans** - 自分の計画書一覧（要認証）
9. **/my/plans/:id** - 計画書詳細閲覧（要認証）

## 7. 受け入れ基準（E2E）

1. **計画書取り込みから検索**
   - 計画書を入力/アップロード後、空き状況「open」の施設が検索結果上位に表示される

2. **空き状況の動的更新**
   - 施設が空き状況を更新すると、検索結果の順位が即座に変動する

3. **同意取得フロー**
   - 同意リンクから承認すると、consentsレコードが作成され、ケース画面に反映される

4. **照会・返信フロー**
   - 照会送信後、施設が「受入可」で返信すると、ケース進捗が更新される

## 8. データプライバシー要件

- 利用者の個人情報は最小限に留める（連絡先のみ）
- 計画書の詳細情報は支援者と施設担当者のみアクセス可能
- 同意取得の証跡は改ざん防止措置を実施
- ユーザー情報、施設情報は高度に細分化されたテーブルで管理
  - 必要な情報のみを必要な時に取得
  - 個人情報の分散管理によるリスク低減

## 9. 初期データ要件

- 厚労省様式ベースの計画書サンプル1件
  - serviceType: 生活介護
  - area: 半径5km
  - accessibility: 送迎可
- 施設サンプル3件（空き状況: open/limited/closed各1件）

## 10. 設計フェーズでの主要変更点

### 10.1 データベース設計の変更
- **ユーザー情報の細分化**: users、user_profiles、user_addresses、user_authentications、user_rolesに分割
- **施設情報の細分化**: facilities、facility_profiles、facility_locations、facility_contacts、facility_services、facility_conditionsに分割
- **matchesテーブルの削除**: RDBでの管理の複雑さから、検索結果は一時的なキャッシュで管理
- **監査ログの簡素化**: diffフィールドを削除し、シンプルな追跡のみ

### 10.2 アーキテクチャの変更
- **API HandlersからServer Actionsへ**: Next.js Route HandlersをServer Components + Server Actionsに変更
- **コロケーション配置**: actionsを各ページの近くに配置、共通ロジックはuc/ディレクトリに集約
- **ドメイン層の追加**: ビジネスロジックをドメインモデルにカプセル化

### 10.3 ユーザーモデルの分離
- **システムユーザーとサービス利用者の分離**: 
  - `supporters`テーブル: 支援者（1テナントのみ所属、計画作成）
  - `users`テーブル: 福祉サービス利用者（マイページ機能あり）
  - `facility_staff`テーブル: 施設スタッフ（ロールベースの権限管理）
- **認証の拡張**: Userも任意でSupabase Auth (Magic Link)を利用可能
- **ロール管理の簡素化**: 各ユーザー種別を別テーブルで管理

### 10.4 計画書のバージョン管理
- **バージョン管理の導入**:
  - `plan_versions`テーブルで各バージョンを管理
  - 計画書の内容はバージョンテーブルに保存
  - アクセシビリティ要件やカスタムフィールドもバージョンごとに管理
- **運用を考慮した設計**:
  - 更新理由の記録によるトレーサビリティ
  - 前バージョンで何を重視していたかを確認可能
  - 有効期間の管理（valid_from/valid_until）

### 10.5 施設スタッフのロールベース管理
- **拡張性のある設計**:
  - `facility_staff`として統一管理
  - `facility_staff_roles`でロールベースの権限管理
  - admin/staff/viewerなど、将来的なロール追加が容易
- **柔軟な権限管理**:
  - 施設ごとに異なるロールを持つことが可能
  - ロールに応じた機能制限を実装